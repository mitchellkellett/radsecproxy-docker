name: Build radsecproxy Docker Image
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/radsecproxy

jobs:
  # initial-cleanup:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     packages: write
  #   steps:
  #       - name: Clean up untagged images
  #         uses: actions/delete-package-versions@v5
  #         with:
  #           package-name: ${{ github.event.repository.name }}/radsecproxy
  #           package-type: container
  #           min-versions-to-keep: 0
  #           delete-only-untagged-versions: true
            
  check-versions:
    # needs: initial-cleanup
    runs-on: ubuntu-latest
    permissions:
      packages: read
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
      latest: ${{ steps.get-versions.outputs.latest }}
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get missing versions
        id: get-versions
        run: |
          # Get latest stable release (excludes pre-releases)
          LATEST=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases/latest | jq -r '.tag_name')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest stable release: $LATEST"
          
          # Get all releases sorted by published date (oldest first)
          RELEASES=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases | \
            jq -r 'sort_by(.published_at) | .[].tag_name')
          
          # Check which ones are missing
          MISSING=()
          for version in $RELEASES; do
            # Skip the oddly-named release
            if [ "$version" == "radsecproxy-1.6.9" ]; then
              echo "Skipping: $version"
              continue
            fi
            
            # Remove 'v' prefix if present
            VERSION_NUM=${version#v}
            
            # Get base version (strip pre-release suffix)
            BASE_VERSION=$(echo "$VERSION_NUM" | sed 's/-.*$//')
            IFS='.' read -ra PARTS <<< "$BASE_VERSION"
            MAJOR="${PARTS[0]}"
            MINOR="${PARTS[1]}"
            
            # Skip versions before 1.9
            if [ "$MAJOR" -lt 1 ] || ([ "$MAJOR" -eq 1 ] && [ "$MINOR" -lt 9 ]); then
              echo "Skipping (< 1.9): $version"
              continue
            fi
            
            # Check if image exists using buildx imagetools
            TAG="v${VERSION_NUM}"
            echo "Checking for: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
            if docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG} >/dev/null 2>&1; then
              echo "✓ Exists: ${TAG}"
            else
              echo "✗ Missing: ${TAG}"
              MISSING+=("\"$version\"")
            fi
          done
          
          # Create JSON array
          if [ ${#MISSING[@]} -eq 0 ]; then
            echo "versions=[]" >> $GITHUB_OUTPUT
            echo "No missing versions found!"
          else
            VERSIONS=$(printf '%s\n' "${MISSING[@]}" | jq -s -c '.')
            echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
            echo "Missing versions: ${MISSING[@]}"
          fi

  build-version:
    needs: check-versions
    if: needs.check-versions.outputs.versions != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    strategy:
      max-parallel: 1
      matrix:
        version: ${{fromJson(needs.check-versions.outputs.versions)}}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get release metadata
        id: release
        run: |
          VERSION="${{ matrix.version }}"
          
          # Fetch release data
          RELEASE_DATA=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases/tags/${VERSION})
          BODY=$(echo "$RELEASE_DATA" | jq -r '.body // ""' | tr '\r\n' ' ' | tr -s ' ' | head -c 500)
          RELEASE_URL=$(echo "$RELEASE_DATA" | jq -r '.html_url // ""')
          
          echo "description=$BODY" >> $GITHUB_OUTPUT
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
      
      - name: Parse version tags
        id: tags
        run: |
          VERSION="${{ matrix.version }}"
          LATEST="${{ needs.check-versions.outputs.latest }}"
          
          VERSION_NUM=${VERSION#v}
          
          # Check if this is a pre-release
          if [[ "$VERSION_NUM" =~ -(rc|beta|alpha) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release version"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          # Get base version (strip pre-release suffix)
          BASE_VERSION=$(echo "$VERSION_NUM" | sed 's/-.*$//')
          IFS='.' read -ra PARTS <<< "$BASE_VERSION"
          MAJOR="${PARTS[0]}"
          MINOR="${PARTS[1]}"
          PATCH="${PARTS[2]}"
          
          echo "full=v${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "minor=v${MAJOR}.${MINOR}" >> $GITHUB_OUTPUT
          echo "major=v${MAJOR}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          
          # Check if this is the latest stable release
          if [ "$VERSION" == "$LATEST" ]; then
            echo "is_latest=true" >> $GITHUB_OUTPUT
            echo "This is the latest stable release"
          else
            echo "is_latest=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push (latest stable)
        if: steps.tags.outputs.is_latest == 'true' && steps.tags.outputs.is_prerelease == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RADSECVERSION=${{ steps.tags.outputs.version_num }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.full }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.major }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.minor }}
          labels: |
            org.opencontainers.image.title=radsecproxy
            org.opencontainers.image.description=${{ steps.release.outputs.description }}
            org.opencontainers.image.version=${{ steps.tags.outputs.full }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=${{ steps.release.outputs.url }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: Build and push (stable - not latest)
        if: steps.tags.outputs.is_latest == 'false' && steps.tags.outputs.is_prerelease == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RADSECVERSION=${{ steps.tags.outputs.version_num }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.full }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.major }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.minor }}
          labels: |
            org.opencontainers.image.title=radsecproxy
            org.opencontainers.image.description=${{ steps.release.outputs.description }}
            org.opencontainers.image.version=${{ steps.tags.outputs.full }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=${{ steps.release.outputs.url }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: Build and push (pre-release)
        if: steps.tags.outputs.is_prerelease == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RADSECVERSION=${{ steps.tags.outputs.version_num }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.full }}
          labels: |
            org.opencontainers.image.title=radsecproxy
            org.opencontainers.image.description=${{ steps.release.outputs.description }}
            org.opencontainers.image.version=${{ steps.tags.outputs.full }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=${{ steps.release.outputs.url }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: Clean up untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ github.event.repository.name }}/radsecproxy
          package-type: container
          min-versions-to-keep: 0
          delete-only-untagged-versions: true
