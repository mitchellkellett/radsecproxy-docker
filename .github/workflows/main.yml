name: Build radsecproxy Docker Image
on:
  # schedule:
  #   - cron: '0 * * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/radsecproxy

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get and build missing releases
        run: |
          # Get latest release
          LATEST=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases/latest | jq -r '.tag_name')
          echo "Latest release: $LATEST"
          
          # Get all releases and sort them in version order
          RELEASES=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases | jq -r '.[].tag_name' | sort -V)
          
          # Process each version in order
          for version in $RELEASES; do
            # Skip the oddly-named release
            if [ "$version" == "radsecproxy-1.6.9" ]; then
              echo "Skipping oddly-named version: $version"
              continue
            fi
            
            # Remove 'v' prefix if present for comparison
            VERSION_NUM=${version#v}
            
            # Split version into parts
            IFS='.' read -ra PARTS <<< "$VERSION_NUM"
            MAJOR="${PARTS[0]}"
            MINOR="${PARTS[1]}"
            PATCH="${PARTS[2]:-0}"
            
            # Skip versions before 1.9
            if [ "$MAJOR" -lt 1 ] || ([ "$MAJOR" -eq 1 ] && [ "$MINOR" -lt 9 ]); then
              echo "Skipping version $version (before 1.9)"
              continue
            fi
            
            # Check if image already exists
            if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${VERSION_NUM} >/dev/null 2>&1; then
              echo "Image already exists for version: v$VERSION_NUM"
              continue
            fi
            
            echo "Building version: $version"
            
            # Fetch release metadata
            RELEASE_DATA=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases/tags/${version})
            BODY=$(echo "$RELEASE_DATA" | jq -r '.body // ""' | tr '\r\n' ' ' | tr -s ' ' | head -c 500)
            RELEASE_URL=$(echo "$RELEASE_DATA" | jq -r '.html_url // ""')
            
            # Prepare tags
            FULL_TAG="v${VERSION_NUM}"
            MINOR_TAG="v${MAJOR}.${MINOR}"
            MAJOR_TAG="v${MAJOR}"
            
            # Build tag list
            TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${FULL_TAG}"
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MINOR_TAG}"
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${MAJOR_TAG}"
            
            # Add latest tag if this is the latest version
            if [ "$version" == "$LATEST" ]; then
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
              echo "This is the latest version - adding 'latest' tag"
            fi
            
            echo "Tags: $TAGS"
            
            # Build and push
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --build-arg RADSECVERSION=${VERSION_NUM} \
              --tag $(echo "$TAGS" | sed 's/,/ --tag /g') \
              --label "org.opencontainers.image.title=radsecproxy" \
              --label "org.opencontainers.image.description=$BODY" \
              --label "org.opencontainers.image.version=${FULL_TAG}" \
              --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
              --label "org.opencontainers.image.url=${RELEASE_URL}" \
              --label "org.opencontainers.image.revision=${{ github.sha }}" \
              --push \
              .
            
            echo "Successfully built and pushed version: $version"
          done

  cleanup:
    needs: check-and-build
    if: always()
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: radsecproxy-docker/radsecproxy
          package-type: container
          min-versions-to-keep: 0
          delete-only-untagged-versions: true
