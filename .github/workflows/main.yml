name: Build radsecproxy Docker Image
on:
  # schedule:
  #   - cron: '0 * * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/radsecproxy

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
      latest: ${{ steps.get-versions.outputs.latest }}
    steps:
      - name: Get missing versions
        id: get-versions
        run: |
          # Get latest release
          LATEST=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases/latest | jq -r '.tag_name')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          
          # Get all releases and sort them in version order
          RELEASES=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases | jq -r '.[].tag_name' | sort -V)
          
          # Check which ones are missing
          MISSING=()
          for version in $RELEASES; do
            # Skip the oddly-named release
            if [ "$version" == "radsecproxy-1.6.9" ]; then
              continue
            fi
            
            # Remove 'v' prefix if present
            VERSION_NUM=${version#v}
            
            # Split version into parts
            IFS='.' read -ra PARTS <<< "$VERSION_NUM"
            MAJOR="${PARTS[0]}"
            MINOR="${PARTS[1]}"
            
            # Skip versions before 1.9
            if [ "$MAJOR" -lt 1 ] || ([ "$MAJOR" -eq 1 ] && [ "$MINOR" -lt 9 ]); then
              continue
            fi
            
            # Check if image already exists
            if ! docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${VERSION_NUM} >/dev/null 2>&1; then
              MISSING+=("\"$version\"")
            fi
          done
          
          # Create JSON array
          if [ ${#MISSING[@]} -eq 0 ]; then
            echo "versions=[]" >> $GITHUB_OUTPUT
          else
            VERSIONS=$(printf '%s\n' "${MISSING[@]}" | jq -s -c '.')
            echo "versions=$VERSIONS" >> $GITHUB_OUTPUT
          fi

  build-version:
    needs: check-versions
    if: needs.check-versions.outputs.versions != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    strategy:
      max-parallel: 1
      matrix:
        version: ${{fromJson(needs.check-versions.outputs.versions)}}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Get release metadata
        id: release
        run: |
          VERSION="${{ matrix.version }}"
          
          # Fetch release data
          RELEASE_DATA=$(curl -s https://api.github.com/repos/radsecproxy/radsecproxy/releases/tags/${VERSION})
          BODY=$(echo "$RELEASE_DATA" | jq -r '.body // ""' | tr '\r\n' ' ' | tr -s ' ' | head -c 500)
          RELEASE_URL=$(echo "$RELEASE_DATA" | jq -r '.html_url // ""')
          
          echo "description=$BODY" >> $GITHUB_OUTPUT
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
      
      - name: Parse version tags
        id: tags
        run: |
          VERSION="${{ matrix.version }}"
          LATEST="${{ needs.check-versions.outputs.latest }}"
          
          VERSION_NUM=${VERSION#v}
          IFS='.' read -ra PARTS <<< "$VERSION_NUM"
          MAJOR="${PARTS[0]}"
          MINOR="${PARTS[1]}"
          PATCH="${PARTS[2]}"
          
          echo "full=v${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "minor=v${MAJOR}.${MINOR}" >> $GITHUB_OUTPUT
          echo "major=v${MAJOR}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          
          if [ "$VERSION" == "$LATEST" ]; then
            echo "is_latest=true" >> $GITHUB_OUTPUT
          else
            echo "is_latest=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push (latest)
        if: steps.tags.outputs.is_latest == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RADSECVERSION=${{ steps.tags.outputs.version_num }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.full }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.major }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=radsecproxy
            org.opencontainers.image.description=${{ steps.release.outputs.description }}
            org.opencontainers.image.version=${{ steps.tags.outputs.full }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=${{ steps.release.outputs.url }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: Build and push (not latest)
        if: steps.tags.outputs.is_latest == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            RADSECVERSION=${{ steps.tags.outputs.version_num }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.full }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.major }}
          labels: |
            org.opencontainers.image.title=radsecproxy
            org.opencontainers.image.description=${{ steps.release.outputs.description }}
            org.opencontainers.image.version=${{ steps.tags.outputs.full }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=${{ steps.release.outputs.url }}
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: Clean up untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: radsecproxy-docker/radsecproxy
          package-type: container
          min-versions-to-keep: 0
          delete-only-untagged-versions: true
